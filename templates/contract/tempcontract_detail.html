{% extends current_module.base_template %}
{% load i18n material_form material_frontend %}
{% load humanize %}

{% block breadcrumbs_items %}
<a href="{% url view.model|frontend_urlname:'list' %}">{{ view.model|verbose_name_plural|title }}</a>
<a class="active">{{ object }}</a>
{% endblock %}

{% block content %}
{% block left-panel %}
<div class="left-panel">
    <div class="card">
        <div class="card-content">
            {% block card %}
            <div class="card-title">{{ view.model|verbose_name|title }}: {{ object }}</div>
            <table class="table bordered">
                {% for field_name, value in object_data %}
                <tr>
                    <th>{{ field_name }}</th>
                    {% if value.get_absolute_url %}
                    <td><a href="{{ value.get_absolute_url }}">{{ value }}</a></td>
                    {% else %}
                    <td>{{ value }}</td>
                    {% endif %}
                </tr>
                {% endfor %}
            </table>
            {% endblock %}
        </div>
        <div class="card-action">
            <div class="right-align">
                {% block actions_row %}
                {% if delete_url %}<a class="waves-effect waves-light btn red white-text" href="{{ delete_url }}">{% trans 'Delete' %}</a>{% endif %}
                {% if object.contractor %}
                <a class="waves-effect waves-light btn white-text popup" href="{% url 'admin:contract_contractor_change' object.contractor.pk %}?_popup=1">契約者変更</a>
                {% else %}
                <a class="waves-effect waves-light btn white-text popup" href="{% url 'admin:contract_subscription_change' object.subscription.pk %}?_popup=1">申込者変更</a>
                {% endif %}
                {% if change_url %}<a class="waves-effect waves-light btn white-text popup" href="{{ change_url }}">{% trans 'Change' %}</a>{% endif %}
                {% endblock actions_row %}
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-content">
            <div class="card-title">進捗情報</div>
            <div>進捗：<span class="percentage">{{ object.percent }}</span> %</div>
            <div class="progress" style="height: 14px;">
                <div class="determinate" style="width: {{ object.percent }}%"></div>
            </div>
            <ul class="collapsible" data-collapsible="expandable">
                {% for task in object.contract.get_contract_process.task_set.all %}
                {% with group=task.get_mail_group template=task.get_mail_template %}
                <li>
                    <div class="collapsible-header">
                        <span class="icon-stack">
                             <i class="icon-sign-blank icon-stack-base"></i>
                             <span class="icon-fixed-width icon-light char-overlay">{{ forloop.counter }}</span>
                        </span>
                        {{ task }}
                        {% if task.status == '01' %}
                            <!-- 未実施 -->
                            <span class="new badge red" data-badge-caption="{{ task.get_status_display }}" style="margin-left: 0px;"></span>
                        {% elif task.status == '02' %}
                            <!-- 実施中 -->
                            <span class="new badge purple" data-badge-caption="{{ task.get_status_display }}" style="margin-left: 0px;"></span>
                        {% elif task.status == '10' %}
                            <!-- スキップ -->
                            <span class="new badge grey" data-badge-caption="{{ task.get_status_display }}" style="margin-left: 0px;"></span>
                        {% elif task.status == '99' %}
                            <span class="new badge grey" data-badge-caption="{{ task.get_status_display }}" style="margin-left: 0px;"></span>
                        {% endif %}
                    </div>
                    <div class="collapsible-body">
                        {% if task.category == "010" %}
                            <!-- 申込書送付 -->
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col s8">
                                    <input type="checkbox" class="filled-in" id="chkSubscriptionConfirm" checked="checked"
                                           data-task-url="{% url 'format:report_subscription_confirm' task.pk subscription_confirm_template.pk %}" />
                                    <label for="chkSubscriptionConfirm">申込確認書</label>
                                </div>
                                <div class="col s2">
                                    <a target="_blank" href="{% url 'format:report_subscription_confirm' task.pk subscription_confirm_template.pk %}" class="tooltipped" data-position="left" data-delay="50" data-tooltip="プレビュー"><i class="material-icons">find_in_page</i></a>
                                </div>
                                <div class="col s2">
                                    <a target="_blank" href="{% url 'format:download_report_subscription_confirm' task.pk subscription_confirm_template.pk %}" class="tooltipped" data-position="left" data-delay="50" data-tooltip="ダウンロード"><i class="material-icons">file_download</i></a>
                                </div>
                            </div>
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col s8">
                                    <input type="checkbox" class="filled-in" id="chkSubscription" checked="checked"
                                           data-task-url="{% url 'format:report_subscription' task.pk subscription_template.pk %}" />
                                    <label for="chkSubscription">申込書</label>
                                </div>
                                <div class="col s2">
                                    <a target="_blank" href="{% url 'format:report_subscription' task.pk subscription_template.pk %}" class="tooltipped" data-position="left" data-delay="50" data-tooltip="プレビュー"><i class="material-icons">find_in_page</i></a>
                                </div>
                                <div class="col s2">
                                    <a target="_blank" href="{% url 'format:download_report_subscription' task.pk subscription_template.pk %}" class="tooltipped" data-position="left" data-delay="50" data-tooltip="ダウンロード"><i class="material-icons">file_download</i></a>
                                </div>
                            </div>
                            <!-- 申込時メール送信の確認ボックス -->
                            <div id="send_subscription" class="modal modal-fixed-footer" style="min-height: 500px;">
                                <form method="post" action="{% url 'contract:send_subscription_mail' task.pk %}" id="frmSendSubscriptionMail">
                                    {{ formset.management_form }}
                                    <input type="hidden" id="hidSubscriptionUrl" name="subscription_url"/>
                                    <div class="modal-content">
                                        <h4>申込書の送付</h4>
                                        <div class="row">
                                            <div class="col s12">
                                                <div class="row">
                                                    <div class="input-field col s12">
                                                        <input readonly value="{{ group.sender }}" id="txtSubscriptionSender" name="subscription_sender" type="text" />
                                                        <label for="txtSubscriptionSender">差出人</label>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="input-field col s12">
                                                        <input value="{% if object.contractor %}{{ object.contractor.email }}{% else %}{{ object.subscription.email }}{% endif %}" id="txtSubscriptionTo" name="subscription_to" type="text" />
                                                        <label for="txtSubscriptionTo">宛先</label>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="input-field col s12">
                                                        <input value="{%for cc in group.get_cc_list%}{{cc.email}}{%endfor%}" id="txtSubscriptionCC" name="subscription_cc" type="text" />
                                                        <label for="txtSubscriptionCC">ＣＣ</label>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="input-field col s12">
                                                        <input value="{%for bcc in group.get_bcc_list%}{{bcc.email}}{%endfor%}" id="txtSubscriptionBCC" name="subscription_bcc" type="text" />
                                                        <label for="txtSubscriptionBCC">ＢＣＣ</label>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="input-field col s12">
                                                        <input value="{{ template.title }}" id="txtSubscriptionTitle" name="subscription_title" type="text" />
                                                        <label for="txtSubscriptionTitle">件名</label>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="input-field col s12">
                                                        <textarea id="txtSubscriptionContent" name="subscription_content" class="materialize-textarea" style="min-height: 300px;">{{ template.body|safe }}</textarea>
                                                        <label for="txtSubscriptionContent">メール本文</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button class="modal-action btn-flat waves-effect waves-green" type="submit" name="action">送信
                                            <i class="material-icons right">send</i>
                                        </button>
                                        <a href="javascript:void(0)" class="modal-action modal-close waves-effect waves-red btn-flat ">キャンセル</a>
                                    </div>
                                </form>
                            </div>
                        {% elif task.category == "011" %}
                            <!-- 申込書確認 -->
                            {% for report_file in task.reports.all %}
                                <div class="row" style="margin-bottom: 5px;">
                                    <div class="col s4">
                                        <a target="_blank" href="{{ MEDIA_URL }}{{ report_file.path }}">{{ report_file.name }}</a>
                                    </div>
                                    <div class="col s8">申込み日時：{{ report_file.updated_date }} </div>
                                </div>
                            {% empty %}
                                <div class="row" style="margin-bottom: 5px;">
                                    <div class="col s12">
                                        <span class="red-text">ユーザーはまだ申込みされていません。</span>
                                    </div>
                                </div>
                            {% endfor %}
                        {% elif task.category == '030' %}
                            <!-- 住所・電話番号 審査・確認 -->
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col s4">住所：</div>
                                <div class="col s8">{{ object.contractor.address1|default:'' }}{{ object.contractor.address2|default:'' }}</div>
                            </div>
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col s4">電話番号：</div>
                                <div class="col s8">{{ object.contractor.tel|default:'' }}</div>
                            </div>
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col s4">ファックス：</div>
                                <div class="col s8">{{ object.contractor.fax|default:'' }}</div>
                            </div>
                        {% elif task.category == '031' %}
                            <!-- 勤め先審査 -->
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col s4">勤務先名称：</div>
                                <div class="col s8">{{ object.contractor.workplace_name|default:'' }}</div>
                            </div>
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col s4">勤務先郵便番号：</div>
                                <div class="col s8">{{ object.contractor.workplace_post_code|default:'' }}</div>
                            </div>
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col s4">勤務先住所：</div>
                                <div class="col s8">{{ object.contractor.workplace_address1|default:'' }}{{ object.contractor.workplace_address2|default:'' }}</div>
                            </div>
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col s4">勤務先電話番号：</div>
                                <div class="col s8">{{ object.contractor.workplace_tel|default:'' }}</div>
                            </div>
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col s4">勤務先ファックス：</div>
                                <div class="col s8">{{ object.contractor.workplace_fax|default:'' }}</div>
                            </div>
                        {% elif task.category == '032' and object.car %}
                            <!-- 車両サイズ審査 -->
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col s4">車メーカー：</div>
                                <div class="col s8">{{ object.car.car_maker|default:'' }}</div>
                            </div>
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col s4">車種：</div>
                                <div class="col s8">{{ object.car.car_model|default:'' }}</div>
                            </div>
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col s4">色：</div>
                                <div class="col s8">{{ object.car.car_color|default:'' }}</div>
                            </div>
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col s4">No.プレート：</div>
                                <div class="col s8">{{ object.car.car_no_plate|default:'' }}</div>
                            </div>
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col s4">全長：</div>
                                <div class="col s8">{{ object.car.car_length|default:''|intcomma }}</div>
                            </div>
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col s4">全幅：</div>
                                <div class="col s8">{{ object.car.car_width|default:''|intcomma }}</div>
                            </div>
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col s4">全高：</div>
                                <div class="col s8">{{ object.car.car_height|default:''|intcomma }}</div>
                            </div>
                            <div class="row">
                                <div class="col s4">重量：</div>
                                <div class="col s8">{{ object.car.car_weight|default:''|intcomma }}</div>
                            </div>
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col s1">判定結果</div>
                                <div class="col s3">車室</div>
                                <div class="col s2">全長</div>
                                <div class="col s2">全幅</div>
                                <div class="col s2">全高</div>
                                <div class="col s2">重量</div>
                            </div>
                            {% for suitable_position in object.contract.get_suitable_positions %}
                                {% if suitable_position %}
                                    <div class="row {% if suitable_position.position.pk == object.parking_position.pk %}teal lighten-5{% endif %}" style="margin-bottom: 5px;">
                                        <div class="col s1">{% if suitable_position.is_suitable %}<i class="tiny material-icons">done</i>{% else %}<i class="tiny material-icons red-text">close</i>{% endif %}</div>
                                        <div class="col s3">
                                            <span>{{ suitable_position.position }}</span>
                                        </div>
                                        <div class="col s2">
                                            <span class="{% if not suitable_position.length_suitable %}red-text{% endif %}">
                                                {{ suitable_position.position.length }}
                                                {% if suitable_position.adjust_length > 0 %}(+{{ suitable_position.adjust_length }}){% endif %}
                                            </span>
                                        </div>
                                        <div class="col s2">
                                            <span class="{% if not suitable_position.width_suitable %}red-text{% endif %}">
                                                {{ suitable_position.position.width }}
                                                {% if suitable_position.adjust_width > 0 %}(+{{ suitable_position.adjust_width }}){% endif %}
                                            </span>
                                        </div>
                                        <div class="col s2">
                                            <span class="{% if not suitable_position.height_suitable %}red-text{% endif %}">
                                                {{ suitable_position.position.height }}
                                                {% if suitable_position.adjust_height > 0 %}(+{{ suitable_position.adjust_height }}){% endif %}
                                            </span>
                                        </div>
                                        <div class="col s2">
                                            <span class="{% if not suitable_position.weight_suitable %}red-text{% endif %}">
                                                {{ suitable_position.position.weight }}
                                                {% if suitable_position.adjust_weight > 0 %}(+{{ suitable_position.adjust_weight }}){% endif %}
                                            </span>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% elif task.category == "100" %}
                            <!-- 契約書類送付 -->
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col s8">
                                    <input type="checkbox" class="filled-in" id="chkContract" checked="checked"
                                           data-task-url="{% url 'format:report_subscription_confirm' task.pk subscription_confirm_template.pk %}" />
                                    <label for="chkContract">契約書</label>
                                </div>
                                <div class="col s2">
                                    <a target="_blank" href="javascript:void(0)" class="tooltipped" data-position="left" data-delay="50" data-tooltip="プレビュー"><i class="material-icons">find_in_page</i></a>
                                </div>
                                <div class="col s2">
                                    <a target="_blank" href="javascript:void(0)" class="tooltipped" data-position="left" data-delay="50" data-tooltip="ダウンロード"><i class="material-icons">file_download</i></a>
                                </div>
                            </div>
                            {% for doc in object.parking_lot.docs.all %}
                                <div class="row" style="margin-bottom: 5px;">
                                    <div class="col s8">
                                        <input type="checkbox" class="filled-in" id="id_doc_{{doc.pk}}" checked="checked"
                                               data-task-url="{% url 'format:report_subscription_confirm' task.pk subscription_confirm_template.pk %}" />
                                        <label for="id_doc_{{doc.pk}}">{{ doc }}</label>
                                    </div>
                                    <div class="col s4">
                                        <a target="_blank" href="{{ MEDIA_URL }}{{ doc.path }}" class="tooltipped" data-position="left" data-delay="50" data-tooltip="プレビュー"><i class="material-icons">find_in_page</i></a>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                        {% if task.updated_user %}
                            <div class="row updated_datetime" style="margin-bottom: 5px;">
                                <div class="col s8">
                                    <span style="font-weight: bold;">前回実施日時：</span><span class="updated_date">{{ task.updated_date|default:'' }}</span><br/>
                                </div>
                                <div class="col s4">
                                    <span style="font-weight: bold;">実施者：</span><span class="updated_user">{{ task.updated_user.first_name }}&nbsp;{{ task.updated_user.last_name }}</span>
                                </div>
                            </div>
                        {% endif %}
                        <div>
                            <div class="col s12 right-align">
                                {% if task.category == "010" %}
                                    <a data-target="send_subscription" data-position="left" data-delay="50" data-tooltip="メール送信のダイアログが表示されます。"
                                       class="waves-effect waves-light btn-floating modal-trigger tooltipped {% if object.contract.subscription and object.contract.subscription.status != '01' %}disabled{%endif%}" >
                                        <i class="tiny material-icons">send</i>
                                    </a>
                                {% elif task.category == "100" %}
                                    <a data-position="left" data-delay="50" data-tooltip="メール送信のダイアログが表示されます。"
                                       class="waves-effect waves-light btn-floating tooltipped" >
                                        <i class="tiny material-icons">send</i>
                                    </a>
                                {% endif %}
                                <a data-position="left" data-delay="50" data-tooltip="タスクをスキップします。"
                                   class="waves-effect waves-light btn-floating tooltipped {%if task.is_finished or task.is_skipped%}disabled{%endif%}"
                                   onclick="ebjs.material.task_skip(this, '{% url 'task_skip' task.pk %}', '{{ task }}')">
                                    <i class="tiny material-icons">call_missed_outgoing</i></a>
                                <a data-position="left" data-delay="50" data-tooltip="タスクを完了とします。"
                                   class="waves-effect waves-light btn-floating btn-tiny tooltipped {%if task.is_finished or task.is_skipped%}disabled{%endif%}"
                                   onclick="ebjs.material.task_finish(this, '{% url 'task_finish' task.pk %}', '{{ task }}')">
                                    <i class="tiny material-icons">done</i></a>
                            </div>
                        </div>
                    </div>
                </li>
                {% endwith %}
                {% endfor %}
            </ul>
        </div>
        <div class="card-action">
            <div class="right-align">
                <a class="waves-effect waves-light btn red white-text" href="{% url 'contract:temp_contract_destroy' object.pk %}">破棄</a>
                <a class="waves-effect waves-light btn white-text" href="{% url 'contract:temp_contract_finish' object.pk %}">契約完了</a>
            </div>
        </div>
    </div>
</div>
{% endblock left-panel %}
{% block right-panel %}{% endblock right-panel %}
{% endblock %}

{% block footer %}
<script type="text/javascript" src="/static/tinymce/tinymce.min.js"></script>
<script type="text/javascript" src="/static/tinymce/tinymce.init.js"></script>
<script type="text/javascript">
ebjs.material.popup_anchor();
$(document).ready(function(){
    $('.modal').modal({
        dismissible: true, // Modal can be dismissed by clicking outside of the modal
        opacity: .5, // Opacity of modal background
        inDuration: 300, // Transition in duration
        outDuration: 200, // Transition out duration
        startingTop: '4%', // Starting top style attribute
        endingTop: '10%', // Ending top style attribute
        ready: function(modal, trigger) { // Callback for Modal open. Modal and trigger parameters available.
            var subscription_url = "";
            if ($("#chkSubscriptionConfirm").prop("checked")) {
                subscription_url += $("#chkSubscriptionConfirm").attr("data-task-url") + ",";
            }
            if ($("#chkSubscription").prop("checked")) {
                subscription_url += $("#chkSubscription").attr("data-task-url") + ",";
            }
            $("#hidSubscriptionUrl").val(subscription_url);
            ebjs.material.reset_mce_data_href();
        },
        complete: function(obj) {
            //alert('Closed');
        }
    });

    // 申込書の送信イベント
    ebjs.material.send_subscription_mail(
        "frmSendSubscriptionMail",
        subscription_sent_success_fn,
        subscription_sent_failure_fn,
        subscription_sent_always_fn
    );
});

function subscription_sent_success_fn(result) {
    if (result.error) {
        alert(result.message);
    } else {
        Materialize.toast('メール送信しました!', 10000);
        $('#send_subscription').modal('close');
        var obj = $("a[data-target=send_subscription]");
        $(obj).next().addClass('disabled');
        $(obj).next().next().addClass('disabled');
        // 次のタスクを実施中にする
        ebjs.material.set_task_status($(obj).closest('li').next(), '02');
        // 進捗更新
        ebjs.material.update_task_info(obj, '99');
        // 前回送信時間と送信者
        obj.closest('li').find('span.updated_date').text(result.updated_date);
        obj.closest('li').find('span.updated_user').text(result.updated_user);
    }
}

function subscription_sent_failure_fn(result) {
    // debugger;
}

function subscription_sent_always_fn(result) {
    // debugger;
}

</script>
{% endblock %}
